default_platform(:ios)

platform :ios do
  desc "Run tests"
  lane :test do
    run_tests(
      scheme: "AxiomHiveApp",
      devices: ["iPhone 15 Pro"],
      code_coverage: true,
      output_directory: "./test_output"
    )
  end

  desc "Build and upload to TestFlight"
  lane :beta do
    # Ensure we're on a clean state
    ensure_git_status_clean
    
    # Increment build number
    increment_build_number(
      xcodeproj: "AxiomHiveApp.xcodeproj"
    )
    
    # Setup code signing with Match
    match(
      type: "appstore",
      readonly: is_ci,
      app_identifier: "com.axiomhive.app"
    )
    
    # Build the app
    build_app(
      scheme: "AxiomHiveApp",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "AxiomHiveApp.ipa",
      clean: true,
      include_bitcode: false,
      include_symbols: true
    )
    
    # Upload to TestFlight
    upload_to_testflight(
      api_key_path: "~/.appstoreconnect/private_keys/AuthKey_#{ENV['APP_STORE_CONNECT_API_KEY_ID']}.p8",
      skip_waiting_for_build_processing: true,
      notify_external_testers: false
    )
    
    # Commit version bump
    commit_version_bump(
      message: "Version bump for TestFlight build",
      xcodeproj: "AxiomHiveApp.xcodeproj"
    )
    
    # Add a git tag
    add_git_tag(
      grouping: "testflight",
      prefix: "v",
      build_number: get_build_number(xcodeproj: "AxiomHiveApp.xcodeproj")
    )
    
    # Push to remote
    push_to_git_remote(
      tags: true
    )
  end

  desc "Build and submit to App Store"
  lane :release do
    # Ensure we're on a clean state
    ensure_git_status_clean
    
    # Increment version number
    increment_version_number(
      bump_type: "patch",
      xcodeproj: "AxiomHiveApp.xcodeproj"
    )
    
    # Run beta lane to build and upload
    beta
    
    # Submit for review
    deliver(
      submit_for_review: true,
      automatic_release: false,
      force: true,
      skip_metadata: false,
      skip_screenshots: false,
      precheck_include_in_app_purchases: false
    )
    
    # Notify team
    notification(
      title: "App Store Submission",
      message: "AxiomHiveApp has been submitted for App Store review"
    )
  end

  desc "Run SwiftLint"
  lane :lint do
    swiftlint(
      mode: :lint,
      config_file: ".swiftlint.yml",
      strict: true,
      raise_if_swiftlint_error: true
    )
  end

  desc "Run all checks before commit"
  lane :pre_commit do
    lint
    test
  end

  error do |lane, exception|
    notification(
      title: "Fastlane Error",
      message: "#{lane} failed: #{exception.message}"
    )
  end
end
