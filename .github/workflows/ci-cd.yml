name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*.*.*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deployment_target:
        description: 'Deployment target'
        required: true
        default: 'testflight'
        type: choice
        options:
        - testflight
        - appstore

jobs:
  test:
    name: Run Tests
    runs-on: macos-14
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.2'
    
    - name: Install XcodeGen
      run: brew install xcodegen
    
    - name: Generate Xcode Project
      run: xcodegen generate
    
    - name: Install dependencies
      run: |
        brew install swiftlint
        
    - name: Run SwiftLint
      run: swiftlint lint --strict
      
    - name: Run Tests
      run: |
        xcodebuild test \
          -scheme AxiomHiveApp \
          -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.2' \
          -enableCodeCoverage YES
          
    - name: Upload Coverage
      uses: codecov/codecov-action@v3
      with:
        token: ${{ secrets.CODECOV_TOKEN }}

  build-testflight:
    name: Build and Deploy to TestFlight
    runs-on: macos-14
    needs: test
    if: github.ref == 'refs/heads/main' || github.event.inputs.deployment_target == 'testflight'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.2'
    
    - name: Install XcodeGen
      run: brew install xcodegen
    
    - name: Generate Xcode Project
      run: xcodegen generate
        
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true
        
    - name: Install Fastlane
      run: |
        gem install fastlane
        
    - name: Setup App Store Connect API Key
      env:
        APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
      run: |
        mkdir -p ~/.appstoreconnect/private_keys
        echo "$APP_STORE_CONNECT_API_KEY" > ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8
        
    - name: Build and Deploy to TestFlight
      env:
        FASTLANE_APPLE_APPLICATION_PASSWORD: ${{ secrets.FASTLANE_APPLE_APPLICATION_PASSWORD }}
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
        APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
      run: |
        fastlane beta
        
  build-appstore:
    name: Build and Submit to App Store
    runs-on: macos-14
    needs: test
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.deployment_target == 'appstore'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.2'
    
    - name: Install XcodeGen
      run: brew install xcodegen
    
    - name: Generate Xcode Project
      run: xcodegen generate
        
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true
        
    - name: Install Fastlane
      run: gem install fastlane
        
    - name: Setup App Store Connect API Key
      env:
        APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
      run: |
        mkdir -p ~/.appstoreconnect/private_keys
        echo "$APP_STORE_CONNECT_API_KEY" > ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8
        
    - name: Build and Submit to App Store
      env:
        FASTLANE_APPLE_APPLICATION_PASSWORD: ${{ secrets.FASTLANE_APPLE_APPLICATION_PASSWORD }}
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
        APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
      run: fastlane release
